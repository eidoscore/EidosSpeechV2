<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eidosSpeech ‚Äî TTS App ¬∑ Free Text-to-Speech</title>
    <meta name="description"
        content="Free online text-to-speech app. 1,200+ voices, 75+ languages. Register for API access.">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://eidosspeech.xyz/app">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://eidosspeech.xyz/app">
    <meta property="og:title" content="eidosSpeech ‚Äî Free Text-to-Speech App">
    <meta property="og:description"
        content="Convert text to speech online. 1,200+ voices, 75+ languages. Free forever.">
    <meta property="og:site_name" content="eidosSpeech">
    <meta property="og:image" content="https://eidosspeech.xyz/og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="eidosSpeech ‚Äî Free TTS App">
    <meta name="twitter:description" content="Convert text to speech online. 1,200+ voices, 75+ languages. Free.">
    <meta name="twitter:image" content="https://eidosspeech.xyz/og-image.png">
    
    <!-- Google AdSense Verification -->
    <meta name="google-adsense-account" content="ca-pub-9427183479605031">
    
    <!-- Breadcrumb Schema -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "name": "Home",
        "item": "https://eidosspeech.xyz/"
      },{
        "@type": "ListItem",
        "position": 2,
        "name": "TTS App",
        "item": "https://eidosspeech.xyz/app"
      }]
    }
    </script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: { extend: { fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] }, colors: { brand: { 400: '#34d399', 500: '#10b981', 600: '#059669' } } } }
        }
    </script>
    <style>
        :root {
            color-scheme: dark;
        }

        body {
            background: #050a06;
            color: #e5e7eb;
        }

        .card {
            background: rgba(255, 255, 255, .04);
            border: 1px solid rgba(255, 255, 255, .08);
        }

        textarea {
            resize: none;
        }

        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            height: 4px;
            border-radius: 2px;
            background: rgba(255, 255, 255, .1);
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #10b981;
            cursor: pointer;
        }

        input[type=range]:focus {
            outline: none;
        }

        .modal-bg {
            background: rgba(0, 0, 0, .7);
            backdrop-filter: blur(8px);
        }

        .modal {
            background: #0d1a0f;
            border: 1px solid rgba(255, 255, 255, .1);
        }

        select {
            background: #0d1a0f;
            border: 1px solid rgba(255, 255, 255, .1);
            color: #e5e7eb;
        }

        select option {
            background: #0d1a0f;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(16, 185, 129, .3);
            border-radius: 3px;
        }

        .audio-player::-webkit-media-controls-panel {
            background: #0d1a0f;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .spinner {
            animation: spin .8s linear infinite;
        }

        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fade-in .3s ease forwards;
        }
    </style>
    <!-- Cloudflare Turnstile -->
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
</head>

<body class="font-sans antialiased min-h-screen flex flex-col">

    <!-- ‚îÄ‚îÄ Navbar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <nav class="sticky top-0 z-40 border-b border-white/[.06]"
        style="background: rgba(5,10,6,.9); backdrop-filter: blur(16px);">
        <div class="max-w-6xl mx-auto px-4 h-14 flex items-center justify-between">
            <a href="/" class="flex items-center gap-2">
                <div
                    class="w-7 h-7 rounded-lg bg-brand-500 flex items-center justify-center text-white font-bold text-xs shadow shadow-brand-500/30">
                    e</div>
                <span class="font-bold text-white">eidosSpeech</span>
            </a>
            <div class="flex items-center gap-2">
                <!-- Auth buttons (swapped by JS) -->
                <div id="nav-auth-anon" class="flex items-center gap-2">
                    <button onclick="openModal('login')"
                        class="text-sm text-gray-400 hover:text-white transition-colors px-3 py-1.5 rounded-lg hover:bg-white/5">Sign
                        In</button>
                    <button onclick="openModal('register')"
                        class="text-sm font-medium bg-brand-500 hover:bg-brand-400 text-white px-3 py-1.5 rounded-lg transition-colors">Register</button>
                </div>
                <div id="nav-auth-user" class="hidden items-center gap-3">
                    <span id="nav-user-email" class="text-xs text-gray-500 hidden sm:block"></span>
                    <a href="/dashboard"
                        class="text-sm font-medium text-brand-400 hover:text-brand-300 transition-colors px-3 py-1.5 rounded-lg hover:bg-brand-500/10">Dashboard</a>
                    <button id="nav-logout-btn"
                        class="text-sm text-gray-500 hover:text-white px-3 py-1.5 rounded-lg hover:bg-white/5 transition-colors">Sign
                        Out</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- ‚îÄ‚îÄ Info Banner (tier-aware) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="info-banner"
        class="border-b border-amber-500/20 bg-amber-500/5 px-4 py-2.5 text-center text-sm text-amber-400/80 hidden">
        <span id="info-banner-text"></span>
    </div>

    <!-- ‚îÄ‚îÄ Main App ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <main class="flex-1 max-w-6xl mx-auto w-full px-4 py-8">
        <h1 class="sr-only">eidosSpeech Text-to-Speech Application</h1>
        <div class="grid lg:grid-cols-[1fr_320px] gap-6">

            <!-- Left: TTS Form -->
            <div class="space-y-5">

                <!-- Mode Tabs -->
                <div class="flex gap-2 border-b border-white/[.06] pb-1">
                    <button id="tab-single" onclick="switchMode('single')" 
                        class="px-4 py-2 text-sm font-medium rounded-t-lg transition-colors bg-white/5 text-white border-b-2 border-brand-500">
                        Single Voice
                    </button>
                    <button id="tab-script" onclick="switchMode('script')" 
                        class="px-4 py-2 text-sm font-medium rounded-t-lg transition-colors text-gray-400 hover:text-white hover:bg-white/5 flex items-center gap-2">
                        Multi-Voice Script
                        <span class="text-[10px] px-1.5 py-0.5 rounded bg-brand-500/20 text-brand-400 font-semibold">NEW</span>
                    </button>
                </div>

                <!-- Single Voice Mode -->
                <div id="mode-single" class="space-y-5">
                    <!-- Text Input -->
                    <div class="card rounded-2xl p-5">
                    <div class="flex items-center justify-between mb-3">
                        <label class="text-sm font-medium text-gray-300">Text to synthesize</label>
                        <div class="flex items-center gap-2">
                            <span id="char-count" class="text-xs text-gray-500">0</span>
                            <span class="text-xs text-gray-600">/</span>
                            <span id="char-limit" class="text-xs text-gray-500">500</span>
                        </div>
                    </div>
                    <textarea id="tts-text" rows="8" placeholder="Type or paste your text here‚Ä¶"
                        class="w-full bg-transparent text-gray-200 placeholder-gray-600 text-sm leading-relaxed focus:outline-none"
                        maxlength="500" oninput="updateCharCount()"></textarea>
                    <!-- Character bar -->
                    <div class="mt-3 h-1 rounded-full bg-white/5 overflow-hidden">
                        <div id="char-bar" class="h-full rounded-full bg-brand-500 transition-all" style="width:0%">
                        </div>
                    </div>
                </div>

                <!-- Voice + Controls -->
                <div class="card rounded-2xl p-5 space-y-5">
                    <!-- Voice Presets -->
                    <div id="presets-section">
                        <div class="flex items-center justify-between mb-3">
                            <label class="text-sm font-medium text-gray-300">Voice Presets</label>
                            <button onclick="showShortcutsHelp()" class="text-xs text-gray-500 hover:text-brand-400 transition-colors flex items-center gap-1">
                                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Shortcuts
                            </button>
                        </div>
                        <div id="presets-grid" class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-4">
                            <!-- Presets loaded dynamically -->
                        </div>
                    </div>

                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <label class="text-sm font-medium text-gray-300">Voice</label>
                            <div class="flex items-center gap-2">
                                <button id="filter-favorites" onclick="toggleFavoritesFilter()" class="text-xs px-2 py-1 rounded-lg bg-white/5 hover:bg-white/10 text-gray-400 hover:text-brand-400 transition-colors">
                                    ‚≠ê Favorites
                                </button>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <select id="voice-select"
                                class="flex-1 rounded-xl px-3 py-2.5 text-sm focus:outline-none focus:border-brand-500/50">
                                <option value="">Loading voices...</option>
                            </select>
                            <button id="preview-voice-btn" onclick="previewVoice()" class="w-10 h-10 rounded-xl bg-white/5 hover:bg-brand-500/20 flex items-center justify-center text-gray-400 hover:text-brand-400 transition-colors" title="Preview voice">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M8 5v14l11-7z"/>
                                </svg>
                            </button>
                            <button id="favorite-btn" onclick="toggleFavorite()" class="w-10 h-10 rounded-xl bg-white/5 hover:bg-white/10 flex items-center justify-center text-gray-500 hover:text-amber-400 transition-colors">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                                </svg>
                            </button>
                            <select id="lang-filter"
                                class="w-32 rounded-xl px-3 py-2.5 text-sm focus:outline-none focus:border-brand-500/50"
                                onchange="filterVoices()">
                                <option value="">All langs</option>
                            </select>
                        </div>
                    </div>

                    <!-- Voice Style Controls (F2) -->
                    <div id="style-controls" class="hidden">
                        <div class="flex justify-between mb-2">
                            <label class="text-xs text-gray-400">Voice Style</label>
                            <span id="style-desc" class="text-xs text-gray-500"></span>
                        </div>
                        <select id="style-select" class="w-full rounded-xl px-3 py-2.5 text-sm focus:outline-none focus:border-brand-500/50 mb-3" onchange="updateStyleDescription()">
                            <option value="">None (Natural)</option>
                        </select>
                        <div id="style-degree-control" class="hidden">
                            <div class="flex justify-between mb-2">
                                <label class="text-xs text-gray-400">Style Intensity</label>
                                <span id="style-degree-value" class="text-xs text-brand-400 font-mono">1.0</span>
                            </div>
                            <input type="range" id="style-degree" min="0.01" max="2.0" step="0.1" value="1.0"
                                oninput="updateSlider('style-degree')" class="w-full">
                        </div>
                    </div>

                    <!-- Sliders -->
                    <div class="grid sm:grid-cols-3 gap-4">
                        <div>
                            <div class="flex justify-between mb-2">
                                <label class="text-xs text-gray-400">Speed</label>
                                <span id="rate-value" class="text-xs text-brand-400 font-mono">+0%</span>
                            </div>
                            <input type="range" id="rate" min="-50" max="100" step="5" value="0"
                                oninput="updateSlider('rate')" class="w-full">
                        </div>
                        <div>
                            <div class="flex justify-between mb-2">
                                <label class="text-xs text-gray-400">Pitch</label>
                                <span id="pitch-value" class="text-xs text-brand-400 font-mono">+0Hz</span>
                            </div>
                            <input type="range" id="pitch" min="-50" max="50" step="5" value="0"
                                oninput="updateSlider('pitch')" class="w-full">
                        </div>
                        <div>
                            <div class="flex justify-between mb-2">
                                <label class="text-xs text-gray-400">Volume</label>
                                <span id="volume-value" class="text-xs text-brand-400 font-mono">+0%</span>
                            </div>
                            <input type="range" id="volume" min="-50" max="50" step="5" value="0"
                                oninput="updateSlider('volume')" class="w-full">
                        </div>
                    </div>
                </div>

                <!-- Generate Button -->
                <button id="generate-btn" onclick="generateTTS()"
                    class="w-full bg-brand-500 hover:bg-brand-400 disabled:opacity-50 disabled:cursor-not-allowed text-white font-semibold py-3.5 rounded-xl transition-all shadow-lg shadow-brand-500/20 hover:shadow-brand-500/30 flex items-center justify-center gap-2">
                    <svg id="btn-icon" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span id="btn-text">Generate Speech</span>
                </button>

                <!-- Subtitle Option -->
                <label class="flex items-center gap-2 text-sm text-gray-400 cursor-pointer hover:text-gray-300 transition-colors">
                    <input type="checkbox" id="generate-subtitle" class="accent-brand-500">
                    <span>Generate subtitle file (.srt)</span>
                </label>

                <!-- eidosStack Banner -->
                <div
                    class="card rounded-2xl p-4 mt-6 flex flex-col sm:flex-row items-center justify-between gap-4 bg-white/[.02] border border-white/[.05]">
                    <div class="flex items-center gap-3 w-full sm:w-auto">
                        <img src="/static/eidosstack-icon.ico"
                            class="w-10 h-10 rounded-xl shadow-lg shadow-brand-500/10" alt="eidosStack">
                        <div class="flex flex-col">
                            <span class="font-bold text-white text-sm">eidosStack</span>
                            <span class="text-[10px] text-gray-500 uppercase tracking-widest">Free tools era</span>
                        </div>
                    </div>

                    <p
                        class="text-xs text-gray-400 text-center sm:text-left flex-1 px-2 leading-relaxed hidden sm:block">
                        part of the ecosystem. we got OCR, AI, everything free for the homies. no cap.
                    </p>

                    <a href="https://eidosstack.com" target="_blank"
                        class="w-full sm:w-auto text-center text-xs font-medium bg-brand-500/10 hover:bg-brand-500/20 text-brand-400 border border-brand-500/20 rounded-xl px-4 py-2.5 transition-colors whitespace-nowrap">
                        Let him cook ‚Üí
                    </a>
                </div>

                <!-- Audio Player -->
                <div id="audio-section" class="card rounded-2xl p-5 hidden fade-in">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm font-medium text-gray-300">Output</span>
                        <div class="flex items-center gap-2 text-xs text-gray-500">
                            <span id="cache-badge"
                                class="hidden bg-brand-500/10 text-brand-400 border border-brand-500/20 px-2 py-0.5 rounded-full">‚ö°
                                Cached</span>
                            <span id="audio-voice-label"></span>
                        </div>
                    </div>
                    <!-- Waveform Canvas -->
                    <canvas id="waveform-canvas" class="w-full h-20 rounded-xl mb-3 cursor-pointer" style="background: #0d1a0f;"></canvas>
                    <audio id="audio-player" controls class="w-full audio-player hidden"
                        style="height:44px; accent-color:#10b981;"></audio>
                    <div class="flex gap-2 mt-3">
                        <a id="download-btn" href="#" download="tts_audio.mp3"
                            class="flex-1 flex items-center justify-center gap-2 text-sm text-gray-400 hover:text-white bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl py-2.5 transition-colors">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Download MP3
                        </a>
                        <a id="download-srt-btn" href="#" download="tts_subtitle.srt"
                            class="hidden flex-1 flex items-center justify-center gap-2 text-sm text-gray-400 hover:text-white bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl py-2.5 transition-colors">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                            </svg>
                            Download SRT
                        </a>
                    </div>
                </div>
            </div>
            <!-- End Single Voice Mode -->

            <!-- Multi-Voice Script Mode -->
            <div id="mode-script" class="space-y-5 hidden">
                <!-- Script Input -->
                <div class="card rounded-2xl p-5">
                    <div class="flex items-center justify-between mb-3">
                        <label class="text-sm font-medium text-gray-300">Multi-Voice Script</label>
                        <button onclick="showScriptHelp()" class="text-xs text-gray-500 hover:text-brand-400 transition-colors">
                            How to use?
                        </button>
                    </div>
                    <textarea id="script-text" rows="12" placeholder="[Speaker1]: Hello, how are you?
[Speaker2]: I'm doing great, thanks for asking!
[Speaker1]: That's wonderful to hear."
                        class="w-full bg-transparent text-gray-200 placeholder-gray-600 text-sm leading-relaxed focus:outline-none font-mono"
                        oninput="parseScript()"></textarea>
                    <div class="mt-3 text-xs text-gray-500">
                        Format: <code class="text-brand-400">[SpeakerName]: Dialog text</code>
                    </div>
                </div>

                <!-- Voice Mapping -->
                <div class="card rounded-2xl p-5">
                    <label class="text-sm font-medium text-gray-300 mb-3 block">Voice Mapping</label>
                    <div id="voice-mapping" class="space-y-3">
                        <div class="text-sm text-gray-500 text-center py-4">
                            Type your script above to assign voices
                        </div>
                    </div>
                </div>

                <!-- Script Settings -->
                <div class="card rounded-2xl p-5 space-y-4">
                    <div>
                        <label class="text-sm font-medium text-gray-300 mb-2 block">Pause Between Lines</label>
                        <div class="flex items-center gap-3">
                            <input type="range" id="pause-ms" min="0" max="2000" step="100" value="500" 
                                oninput="updatePauseValue()" class="flex-1">
                            <span id="pause-value" class="text-sm text-gray-400 w-16 text-right">500ms</span>
                        </div>
                    </div>
                </div>

                <!-- Generate Button -->
                <button id="generate-script-btn" onclick="generateScript()"
                    class="w-full bg-brand-500 hover:bg-brand-400 text-white font-medium py-3.5 rounded-xl transition-colors flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span id="script-btn-text">Generate Multi-Voice Audio</span>
                </button>

                <!-- Script Audio Player -->
                <div id="script-audio-section" class="card rounded-2xl p-5 hidden fade-in">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm font-medium text-gray-300">Multi-Voice Output</span>
                    </div>
                    <canvas id="script-waveform-canvas" class="w-full h-20 rounded-xl mb-3 cursor-pointer" style="background: #0d1a0f;"></canvas>
                    <audio id="script-audio-player" controls class="w-full audio-player hidden"
                        style="height:44px; accent-color:#10b981;"></audio>
                    <div class="flex gap-2 mt-3">
                        <a id="script-download-btn" href="#" download="multi_voice_script.mp3"
                            class="flex-1 flex items-center justify-center gap-2 text-sm text-gray-400 hover:text-white bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl py-2.5 transition-colors">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Download MP3
                        </a>
                    </div>
                </div>
            </div>
            <!-- End Multi-Voice Script Mode -->
            
            </div>
            <!-- End Left Column -->

            <!-- Right: Sidebar -->
            <div class="space-y-5">

                <!-- AdSense Slot -->
                <div id="ad-slot-top"
                    class="card rounded-2xl p-4 min-h-[250px] flex items-center justify-center border-dashed"
                    style="border-color:rgba(255,255,255,.05);">
                    <div class="text-center text-gray-700 text-xs">
                        <div class="text-2xl mb-1">üì¢</div>
                        Advertisement
                    </div>
                </div>

                <!-- Usage Widget -->
                <div class="card rounded-2xl p-5">
                    <h3 class="text-sm font-semibold text-gray-300 mb-4">Today's Usage</h3>
                    <div id="usage-widget">
                        <div id="usage-anon" class="text-center space-y-3">
                            <p class="text-xs text-gray-500 leading-relaxed">Register for higher limits, API access, and
                                usage tracking.</p>
                            <button onclick="openModal('register')"
                                class="w-full text-sm font-medium bg-brand-500/10 hover:bg-brand-500/20 text-brand-400 border border-brand-500/20 rounded-xl py-2 transition-colors">
                                Register Free ‚Üí
                            </button>
                        </div>
                        <div id="usage-user" class="hidden space-y-3">
                            <div class="flex items-center justify-between text-xs text-gray-500 mb-1">
                                <span>Requests</span>
                                <span><span id="usage-req">0</span> / <span id="usage-req-limit">30</span></span>
                            </div>
                            <div class="h-1.5 rounded-full bg-white/5 overflow-hidden mb-3">
                                <div id="usage-req-bar" class="h-full rounded-full bg-brand-500 transition-all"
                                    style="width:0%"></div>
                            </div>
                            <div class="flex items-center justify-between text-xs text-gray-500 mb-1">
                                <span>Characters</span>
                                <span><span id="usage-chars">0</span> / <span id="usage-chars-limit">2000</span></span>
                            </div>
                            <div class="h-1.5 rounded-full bg-white/5 overflow-hidden">
                                <div id="usage-chars-bar" class="h-full rounded-full bg-brand-500 transition-all"
                                    style="width:0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- API Key Widget (registered only) -->
                <div id="api-key-widget" class="card rounded-2xl p-5 hidden">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-semibold text-gray-300">API Key</h3>
                        <a href="/dashboard"
                            class="text-xs text-brand-400 hover:text-brand-300 transition-colors">Dashboard ‚Üí</a>
                    </div>
                    <div class="flex items-center gap-2 bg-black/30 rounded-xl px-3 py-2 border border-white/5">
                        <code id="api-key-display"
                            class="text-xs text-brand-400 font-mono flex-1 overflow-hidden text-ellipsis whitespace-nowrap">‚Äî</code>
                        <button onclick="copyApiKey()"
                            class="text-xs text-gray-500 hover:text-white transition-colors flex-shrink-0">Copy</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ‚îÄ‚îÄ Auth Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="modal-overlay" class="fixed inset-0 z-50 modal-bg hidden flex items-center justify-center p-4"
        onclick="if(event.target===this)closeModal()">
        <div class="modal rounded-2xl w-full max-w-md shadow-2xl fade-in">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 border-b border-white/5">
                <div>
                    <h2 id="modal-title" class="text-lg font-bold text-white">Sign In</h2>
                    <p id="modal-subtitle" class="text-xs text-gray-500 mt-0.5">Welcome back to eidosSpeech</p>
                </div>
                <button onclick="closeModal()"
                    class="text-gray-600 hover:text-white w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white/5 transition-colors text-xl">&times;</button>
            </div>

            <!-- Login Form -->
            <div id="form-login" class="p-6 space-y-4">
                <div>
                    <label class="text-xs text-gray-400 block mb-1.5">Email address</label>
                    <input id="login-email" type="email" placeholder="you@example.com" autocomplete="email"
                        class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-sm text-white placeholder-gray-600 focus:outline-none focus:border-brand-500/50 transition-colors">
                </div>
                <div>
                    <label class="text-xs text-gray-400 block mb-1.5">Password</label>
                    <input id="login-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"
                        class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-sm text-white placeholder-gray-600 focus:outline-none focus:border-brand-500/50 transition-colors"
                        onkeydown="if(event.key==='Enter')doLogin()">
                </div>
                <!-- Turnstile Widget -->
                <div id="cf-turnstile-login"></div>

                <button id="login-submit-btn" onclick="doLogin()"
                    class="w-full bg-brand-500 hover:bg-brand-400 text-white font-semibold py-2.5 rounded-xl transition-colors shadow-lg shadow-brand-500/20">Sign
                    In</button>
                <div class="flex items-center justify-between text-xs text-gray-500">
                    <button onclick="switchModal('forgot')" class="hover:text-gray-300 transition-colors">Forgot
                        password?</button>
                    <button onclick="switchModal('register')"
                        class="hover:text-brand-400 transition-colors text-brand-500">Create account ‚Üí</button>
                </div>
            </div>

            <!-- Register Form -->
            <div id="form-register" class="p-6 space-y-4 hidden">
                <div>
                    <label class="text-xs text-gray-400 block mb-1.5">Full name <span
                            class="text-gray-600">(optional)</span></label>
                    <input id="reg-name" type="text" placeholder="Your name"
                        class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-sm text-white placeholder-gray-600 focus:outline-none focus:border-brand-500/50 transition-colors">
                </div>
                <div>
                    <label class="text-xs text-gray-400 block mb-1.5">Email address</label>
                    <input id="reg-email" type="email" placeholder="you@example.com" autocomplete="email"
                        class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-sm text-white placeholder-gray-600 focus:outline-none focus:border-brand-500/50 transition-colors">
                </div>
                <div>
                    <label class="text-xs text-gray-400 block mb-1.5">Password <span class="text-gray-600">(min 8
                            characters)</span></label>
                    <input id="reg-password" type="password" placeholder="Strong password" autocomplete="new-password"
                        class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-sm text-white placeholder-gray-600 focus:outline-none focus:border-brand-500/50 transition-colors">
                </div>
                <label class="flex items-start gap-2.5 cursor-pointer">
                    <input id="reg-tos" type="checkbox" class="mt-0.5 accent-brand-500">
                    <span class="text-xs text-gray-400">I agree to the <a href="/tos" target="_blank"
                            class="text-brand-400 hover:underline">Terms of Service</a> and consent to receive
                        transactional emails.</span>
                </label>
                <!-- Turnstile Widget -->
                <div id="cf-turnstile-register"></div>

                <button id="register-submit-btn" onclick="doRegister()"
                    class="w-full bg-brand-500 hover:bg-brand-400 text-white font-semibold py-2.5 rounded-xl transition-colors shadow-lg shadow-brand-500/20">Create
                    Free Account</button>
                <p class="text-center text-xs text-gray-500">Already have an account? <button
                        onclick="switchModal('login')" class="text-brand-400 hover:underline">Sign in</button></p>
            </div>

            <!-- Forgot Password Form -->
            <div id="form-forgot" class="p-6 space-y-4 hidden">
                <p class="text-sm text-gray-400">Enter your email and we'll send a password reset link.</p>
                <input id="forgot-email" type="email" placeholder="you@example.com"
                    class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-sm text-white placeholder-gray-600 focus:outline-none focus:border-brand-500/50 transition-colors">
                <button onclick="doForgot()"
                    class="w-full bg-brand-500 hover:bg-brand-400 text-white font-semibold py-2.5 rounded-xl transition-colors">Send
                    Reset Link</button>
                <p class="text-center text-xs text-gray-500"><button onclick="switchModal('login')"
                        class="text-brand-400 hover:underline">Back to Sign In</button></p>
            </div>
        </div>
    </div>

    <!-- Histats.com Hidden Tracker -->
    <script type="text/javascript">var _Hasync= _Hasync|| [];_Hasync.push(['Histats.start', '1,5010099,4,0,0,0,00010000']);_Hasync.push(['Histats.fasi', '1']);_Hasync.push(['Histats.track_hits', '']);(function() {var hs = document.createElement('script'); hs.type = 'text/javascript'; hs.async = true;hs.src = ('//s10.histats.com/js15_as.js');(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(hs);})();</script><noscript><a href="/" target="_blank"><img  src="//sstatic1.histats.com/0.gif?5010099&101" alt="" border="0" style="display:none"></a></noscript>

    <script src="/static/js/toast.js"></script>
    <script src="/static/js/auth.js"></script>
    <script src="/static/js/api-client.js"></script>
    <script src="/static/js/favorites.js"></script>
    <script src="/static/js/shortcuts.js"></script>
    <script src="/static/js/waveform.js"></script>
    <script>
        // ‚îÄ‚îÄ Voice Management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let allVoices = [];
        let currentAudioBlob = null;
        let allPresets = [];
        let activePreset = null;
        let showingFavoritesOnly = false;
        let waveformVisualizer = null;
        let currentSrtContent = null;
        let voiceStyles = null;
        let currentMode = 'single'; // 'single' or 'script'
        let scriptSpeakers = {}; // {speakerName: voiceId}
        let parsedScript = []; // [{speaker, text}]

        async function loadPresets() {
            try {
                const resp = await fetch('/api/v1/voices/presets');
                const data = await resp.json();
                allPresets = data.presets || [];
                renderPresets();
            } catch (e) {
                console.error('Failed to load presets:', e);
            }
        }

        async function loadVoiceStyles() {
            try {
                const resp = await fetch('/api/v1/voices/styles');
                voiceStyles = await resp.json();
            } catch (e) {
                console.error('Failed to load voice styles:', e);
            }
        }

        function updateStyleControls() {
            const voiceId = document.getElementById('voice-select').value;
            const styleControls = document.getElementById('style-controls');
            const styleSelect = document.getElementById('style-select');
            const styleDegreeControl = document.getElementById('style-degree-control');

            if (!voiceStyles || !voiceId) {
                styleControls.classList.add('hidden');
                return;
            }

            const voiceConfig = voiceStyles.voices[voiceId];
            if (!voiceConfig || !voiceConfig.styles || voiceConfig.styles.length === 0) {
                styleControls.classList.add('hidden');
                return;
            }

            // Show style controls
            styleControls.classList.remove('hidden');

            // Populate style dropdown
            styleSelect.innerHTML = '<option value="">None (Natural)</option>';
            voiceConfig.styles.forEach(style => {
                const desc = voiceStyles.style_descriptions[style] || style;
                styleSelect.innerHTML += `<option value="${style}">${style} - ${desc}</option>`;
            });

            // Show/hide degree control
            if (voiceConfig.supports_degree) {
                styleDegreeControl.classList.remove('hidden');
            } else {
                styleDegreeControl.classList.add('hidden');
            }
        }

        function updateStyleDescription() {
            const style = document.getElementById('style-select').value;
            const descSpan = document.getElementById('style-desc');
            
            if (!style || !voiceStyles) {
                descSpan.textContent = '';
                return;
            }

            const desc = voiceStyles.style_descriptions[style] || '';
            descSpan.textContent = desc;
        }

        function renderPresets() {
            const grid = document.getElementById('presets-grid');
            if (!allPresets.length) {
                grid.innerHTML = '<p class="text-xs text-gray-500 col-span-full">No presets available</p>';
                return;
            }

            grid.innerHTML = allPresets.slice(0, 6).map(preset => `
                <button onclick="applyPreset('${preset.id}')" 
                    class="preset-card text-left p-3 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 hover:border-brand-500/50 transition-all ${activePreset === preset.id ? 'border-brand-500 bg-brand-500/10' : ''}"
                    data-preset-id="${preset.id}">
                    <div class="text-xs font-medium text-white mb-1">${preset.name}</div>
                    <div class="text-[10px] text-gray-500 line-clamp-2">${preset.description}</div>
                </button>
            `).join('');
        }

        function applyPreset(presetId) {
            const preset = allPresets.find(p => p.id === presetId);
            if (!preset) return;

            activePreset = presetId;
            
            // Apply voice
            document.getElementById('voice-select').value = preset.voice;
            
            // Apply rate, pitch, volume
            const rateVal = parseInt(preset.rate.replace(/[^-\d]/g, ''));
            const pitchVal = parseInt(preset.pitch.replace(/[^-\d]/g, ''));
            const volumeVal = parseInt(preset.volume.replace(/[^-\d]/g, ''));
            
            document.getElementById('rate').value = rateVal;
            document.getElementById('pitch').value = pitchVal;
            document.getElementById('volume').value = volumeVal;
            
            updateSlider('rate');
            updateSlider('pitch');
            updateSlider('volume');
            
            renderPresets();
            showToast(`Applied preset: ${preset.name}`, 'success', 2000);
        }

        function toggleFavorite() {
            const voiceId = document.getElementById('voice-select').value;
            if (!voiceId) return;
            
            const isFav = window.favoritesManager.toggle(voiceId);
            updateFavoriteButton();
            showToast(isFav ? 'Added to favorites' : 'Removed from favorites', 'success', 2000);
        }

        function updateFavoriteButton() {
            const voiceId = document.getElementById('voice-select').value;
            const btn = document.getElementById('favorite-btn');
            const isFav = window.favoritesManager.isFavorite(voiceId);
            
            btn.innerHTML = isFav 
                ? '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>'
                : '<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>';
            
            btn.className = isFav 
                ? 'w-10 h-10 rounded-xl bg-amber-500/20 hover:bg-amber-500/30 flex items-center justify-center text-amber-400 transition-colors'
                : 'w-10 h-10 rounded-xl bg-white/5 hover:bg-white/10 flex items-center justify-center text-gray-500 hover:text-amber-400 transition-colors';
        }

        // Voice preview functionality
        let previewAudio = null;

        // Helper function to extract error message
        function getErrorMessage(err) {
            if (err instanceof Error) {
                return err.message;
            }
            if (typeof err === 'string') {
                return err;
            }
            if (err && typeof err === 'object') {
                return err.detail || err.message || JSON.stringify(err);
            }
            return 'An unknown error occurred';
        }

        async function previewVoice() {
            const voiceId = document.getElementById('voice-select').value;
            if (!voiceId) {
                showToast('Please select a voice first', 'warning', 2000);
                return;
            }

            const btn = document.getElementById('preview-voice-btn');
            const originalHTML = btn.innerHTML;
            
            // Stop if already playing
            if (previewAudio && !previewAudio.paused) {
                previewAudio.pause();
                previewAudio = null;
                btn.innerHTML = '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
                return;
            }

            try {
                btn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
                btn.disabled = true;

                // Use preview endpoint (no quota consumption, cached on server)
                const previewUrl = `/api/v1/preview/${encodeURIComponent(voiceId)}`;
                
                previewAudio = new Audio(previewUrl);
                
                btn.innerHTML = '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/></svg>';
                
                previewAudio.onended = () => {
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                    previewAudio = null;
                };
                
                previewAudio.onerror = () => {
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                    showToast('Failed to play preview', 'error', 2000);
                    previewAudio = null;
                };
                
                await previewAudio.play();
            } catch (err) {
                console.error('Preview error:', err);
                showToast(getErrorMessage(err), 'error', 2000);
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        async function previewSpeakerVoice(speaker) {
            const voiceId = document.getElementById(`voice-${speaker}`).value;
            if (!voiceId) {
                showToast('Please select a voice first', 'warning', 2000);
                return;
            }

            // Find the button for this speaker
            const speakerCard = document.querySelector(`#voice-${speaker}`).closest('.bg-\\[\\#0d1a0f\\]');
            const btn = speakerCard?.querySelector('button[onclick*="previewSpeakerVoice"]');
            if (!btn) return;

            const originalHTML = btn.innerHTML;
            
            // Stop if already playing
            if (previewAudio && !previewAudio.paused) {
                previewAudio.pause();
                previewAudio = null;
                btn.innerHTML = '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
                return;
            }

            try {
                btn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
                btn.disabled = true;

                // Use preview endpoint (no quota consumption, cached on server)
                const previewUrl = `/api/v1/preview/${encodeURIComponent(voiceId)}`;
                
                previewAudio = new Audio(previewUrl);
                
                btn.innerHTML = '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/></svg>';
                
                previewAudio.onended = () => {
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                    previewAudio = null;
                };
                
                previewAudio.onerror = () => {
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                    showToast('Failed to play preview', 'error', 2000);
                    previewAudio = null;
                };
                
                await previewAudio.play();
            } catch (err) {
                console.error('Preview error:', err);
                showToast(getErrorMessage(err), 'error', 2000);
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        function toggleFavoritesFilter() {
            showingFavoritesOnly = !showingFavoritesOnly;
            const btn = document.getElementById('filter-favorites');
            btn.className = showingFavoritesOnly
                ? 'text-xs px-2 py-1 rounded-lg bg-brand-500/20 text-brand-400 transition-colors'
                : 'text-xs px-2 py-1 rounded-lg bg-white/5 hover:bg-white/10 text-gray-400 hover:text-brand-400 transition-colors';
            filterVoices();
        }

        // ‚îÄ‚îÄ Mode Switching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function switchMode(mode) {
            currentMode = mode;
            
            // Update tabs
            const tabSingle = document.getElementById('tab-single');
            const tabScript = document.getElementById('tab-script');
            const modeSingle = document.getElementById('mode-single');
            const modeScript = document.getElementById('mode-script');
            
            if (mode === 'single') {
                tabSingle.className = 'px-4 py-2 text-sm font-medium rounded-t-lg transition-colors bg-white/5 text-white border-b-2 border-brand-500';
                tabScript.className = 'px-4 py-2 text-sm font-medium rounded-t-lg transition-colors text-gray-400 hover:text-white hover:bg-white/5 flex items-center gap-2';
                modeSingle.classList.remove('hidden');
                modeScript.classList.add('hidden');
            } else {
                tabSingle.className = 'px-4 py-2 text-sm font-medium rounded-t-lg transition-colors text-gray-400 hover:text-white hover:bg-white/5';
                tabScript.className = 'px-4 py-2 text-sm font-medium rounded-t-lg transition-colors bg-white/5 text-white border-b-2 border-brand-500 flex items-center gap-2';
                modeSingle.classList.add('hidden');
                modeScript.classList.remove('hidden');
            }
        }

        // ‚îÄ‚îÄ Script Parsing ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function parseScript() {
            const scriptText = document.getElementById('script-text').value;
            const lines = scriptText.split('\n').filter(l => l.trim());
            
            parsedScript = [];
            const speakers = new Set();
            
            lines.forEach(line => {
                const match = line.match(/^\[([^\]]+)\]:\s*(.+)$/);
                if (match) {
                    const speaker = match[1].trim();
                    const text = match[2].trim();
                    parsedScript.push({ speaker, text });
                    speakers.add(speaker);
                }
            });
            
            renderVoiceMapping(Array.from(speakers));
        }

        function renderVoiceMapping(speakers) {
            const container = document.getElementById('voice-mapping');
            
            if (speakers.length === 0) {
                container.innerHTML = '<div class="text-sm text-gray-500 text-center py-4">Type your script above to assign voices</div>';
                return;
            }
            
            container.innerHTML = speakers.map(speaker => {
                const currentVoice = scriptSpeakers[speaker] || '';
                const isFav = currentVoice && window.favoritesManager.isFavorite(currentVoice);
                
                return `
                    <div class="space-y-2 mb-4 p-4 rounded-xl bg-white/[.02] border border-white/[.06]">
                        <div class="flex items-center gap-2 mb-2">
                            <label class="text-sm font-medium text-white">${speaker}</label>
                            <button onclick="toggleSpeakerFavorite('${speaker}')" 
                                class="w-7 h-7 rounded-lg ${isFav ? 'bg-amber-500/20 text-amber-400' : 'bg-white/5 text-gray-500 hover:text-amber-400'} flex items-center justify-center transition-colors">
                                ${isFav ? 
                                    '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>' :
                                    '<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>'
                                }
                            </button>
                        </div>
                        <div class="flex gap-2">
                            <select id="lang-${speaker}" onchange="filterSpeakerVoicesByLang('${speaker}')" 
                                class="w-40 rounded-xl px-3 py-2 text-sm bg-[#0d1a0f] border border-white/10 focus:outline-none focus:border-brand-500/50">
                                <option value="">All languages</option>
                            </select>
                            <select id="voice-${speaker}" onchange="updateSpeakerVoice('${speaker}')" 
                                class="flex-1 rounded-xl px-3 py-2 text-sm bg-[#0d1a0f] border border-white/10 focus:outline-none focus:border-brand-500/50">
                                <option value="">Select voice...</option>
                                ${allVoices.map(v => `<option value="${v.id}" ${v.id === currentVoice ? 'selected' : ''}>${v.name} (${v.language_code} ¬∑ ${v.gender})</option>`).join('')}
                            </select>
                            <button onclick="previewSpeakerVoice('${speaker}')" 
                                class="w-10 h-10 rounded-xl bg-white/5 hover:bg-brand-500/20 flex items-center justify-center text-gray-400 hover:text-brand-400 transition-colors" title="Preview voice">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M8 5v14l11-7z"/>
                                </svg>
                            </button>
                            <button onclick="filterSpeakerFavorites('${speaker}')" 
                                class="text-xs px-3 py-2 rounded-xl bg-white/5 hover:bg-white/10 text-gray-400 hover:text-brand-400 transition-colors whitespace-nowrap">
                                ‚≠ê Favs
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Populate language filters
            speakers.forEach(speaker => {
                populateSpeakerLangFilter(speaker);
            });
        }

        function populateSpeakerLangFilter(speaker) {
            const langSel = document.getElementById(`lang-${speaker}`);
            if (!langSel) return;
            
            const langCodes = [...new Set(allVoices.map(v => v.language_code))].sort();
            const displayNames = new Intl.DisplayNames(['en'], { type: 'language' });
            
            langSel.innerHTML = '<option value="">All languages</option>';
            langCodes.forEach(code => {
                try {
                    const name = displayNames.of(code);
                    langSel.innerHTML += `<option value="${code}">${name} (${code})</option>`;
                } catch (e) {
                    langSel.innerHTML += `<option value="${code}">${code}</option>`;
                }
            });
        }

        function filterSpeakerVoicesByLang(speaker) {
            const langSel = document.getElementById(`lang-${speaker}`);
            const voiceSel = document.getElementById(`voice-${speaker}`);
            const lang = langSel.value;
            const currentValue = voiceSel.value;
            
            // Filter voices by language
            let filtered = lang
                ? allVoices.filter(v => v.language_code === lang || v.is_multilingual)
                : allVoices;
            
            // Sort: Native voices first, then Multilingual, then alphabetical
            filtered.sort((a, b) => {
                if (lang) {
                    const aIsNative = a.language_code === lang;
                    const bIsNative = b.language_code === lang;
                    if (aIsNative && !bIsNative) return -1;
                    if (!aIsNative && bIsNative) return 1;
                }
                return a.name.localeCompare(b.name);
            });
            
            voiceSel.innerHTML = '<option value="">Select voice...</option>' + 
                filtered.map(v => `<option value="${v.id}" ${v.id === currentValue ? 'selected' : ''}>${v.name} (${v.language_code} ¬∑ ${v.gender})</option>`).join('');
        }

        function updateSpeakerVoice(speaker) {
            const select = document.getElementById(`voice-${speaker}`);
            scriptSpeakers[speaker] = select.value;
            
            // Update favorite button
            const voiceId = select.value;
            if (voiceId) {
                // Re-render to update favorite button
                const speakers = Object.keys(scriptSpeakers);
                if (speakers.length > 0) {
                    // Just update the specific speaker's favorite button
                    const isFav = window.favoritesManager.isFavorite(voiceId);
                    // Button will be updated on next render
                }
            }
        }

        function toggleSpeakerFavorite(speaker) {
            const select = document.getElementById(`voice-${speaker}`);
            const voiceId = select.value;
            
            if (!voiceId) {
                showToast('Please select a voice first', 'error', 2000);
                return;
            }
            
            const isFav = window.favoritesManager.toggle(voiceId);
            showToast(isFav ? 'Added to favorites' : 'Removed from favorites', 'success', 2000);
            
            // Re-render voice mapping to update button
            const speakers = parsedScript.map(line => line.speaker);
            const uniqueSpeakers = [...new Set(speakers)];
            renderVoiceMapping(uniqueSpeakers);
        }

        function filterSpeakerFavorites(speaker) {
            const voiceSel = document.getElementById(`voice-${speaker}`);
            const langSel = document.getElementById(`lang-${speaker}`);
            const currentValue = voiceSel.value;
            const favorites = window.favoritesManager.getAll();
            
            if (favorites.length === 0) {
                showToast('No favorite voices yet. Click ‚≠ê to add favorites!', 'info', 3000);
                return;
            }
            
            // Filter to show only favorites
            const favVoices = allVoices.filter(v => favorites.includes(v.id));
            
            voiceSel.innerHTML = '<option value="">Select voice...</option>' + 
                favVoices.map(v => `<option value="${v.id}" ${v.id === currentValue ? 'selected' : ''}>${v.name} (${v.language_code} ¬∑ ${v.gender})</option>`).join('');
            
            // Reset language filter
            langSel.value = '';
            
            showToast(`Showing ${favVoices.length} favorite voices`, 'success', 2000);
        }

        function updatePauseValue() {
            const val = document.getElementById('pause-ms').value;
            document.getElementById('pause-value').textContent = val + 'ms';
        }

        function showScriptHelp() {
            showToast('Format: [SpeakerName]: Dialog text. Each line must start with [Speaker] followed by colon and text.', 'info', 5000);
        }

        // ‚îÄ‚îÄ Script Generation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function generateScript() {
            const btn = document.getElementById('generate-script-btn');
            const btnText = document.getElementById('script-btn-text');
            
            // Validate
            if (parsedScript.length === 0) {
                showToast('Please enter a valid script with [Speaker]: Dialog format', 'error');
                return;
            }
            
            // Check all speakers have voices
            const missingVoices = parsedScript.filter(line => !scriptSpeakers[line.speaker]);
            if (missingVoices.length > 0) {
                showToast('Please assign voices to all speakers', 'error');
                return;
            }
            
            // Build voice map
            const voiceMap = {};
            Object.keys(scriptSpeakers).forEach(speaker => {
                voiceMap[speaker] = scriptSpeakers[speaker];
            });
            
            // Build script text
            const script = parsedScript.map(line => `[${line.speaker}]: ${line.text}`).join('\n');
            const pauseMs = parseInt(document.getElementById('pause-ms').value);
            
            btn.disabled = true;
            btnText.textContent = 'Generating...';
            
            try {
                const resp = await ApiClient.post('/tts/script', {
                    script: script,
                    voice_map: voiceMap,
                    pause_ms: pauseMs
                });
                
                if (!resp.ok) {
                    const err = await resp.json();
                    throw new Error(err.detail || 'Failed to generate script');
                }
                
                const blob = await resp.blob();
                const url = URL.createObjectURL(blob);
                
                // Show audio player
                const audioSection = document.getElementById('script-audio-section');
                const audioPlayer = document.getElementById('script-audio-player');
                const downloadBtn = document.getElementById('script-download-btn');
                
                audioPlayer.src = url;
                downloadBtn.href = url;
                audioSection.classList.remove('hidden');
                audioPlayer.classList.remove('hidden');
                
                showToast('Multi-voice audio generated!', 'success');
            } catch (e) {
                console.error(e);
                showToast(e.message || 'Failed to generate script', 'error');
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Generate Multi-Voice Audio';
            }
        }

        async function loadVoices() {
            try {
                const resp = await fetch('/api/v1/voices');
                const data = await resp.json();
                allVoices = data.voices || [];

                // Populate language filter with friendly names
                const langCodes = [...new Set(allVoices.map(v => v.language_code))].sort();
                const langSel = document.getElementById('lang-filter');
                const displayNames = new Intl.DisplayNames(['en'], { type: 'language' });

                langSel.innerHTML = '<option value="">All languages</option>';

                langCodes.forEach(code => {
                    try {
                        // code is like "en-US", "id-ID"
                        // We want "Indonesian (Indonesia)" or just "Indonesian"
                        const name = displayNames.of(code);
                        langSel.innerHTML += `<option value="${code}">${name} (${code})</option>`;
                    } catch (e) {
                        langSel.innerHTML += `<option value="${code}">${code}</option>`;
                    }
                });

                filterVoices();
            } catch (e) {
                console.error(e); // Debug
                showToast('Failed to load voices.', 'error');
            }
        }

        function filterVoices() {
            const lang = document.getElementById('lang-filter').value;
            const sel = document.getElementById('voice-select');
            const prevVal = sel.value;

            // Filter: Match language OR is_multilingual (if language is selected)
            let filtered = lang
                ? allVoices.filter(v => v.language_code === lang || v.is_multilingual)
                : allVoices;

            // Apply favorites filter
            if (showingFavoritesOnly) {
                const favorites = window.favoritesManager.getAll();
                console.log('Filtering favorites:', favorites);
                filtered = filtered.filter(v => favorites.includes(v.id));
                console.log('Filtered voices:', filtered.length);
                
                if (filtered.length === 0) {
                    showToast('No favorite voices yet. Click ‚≠ê to add favorites!', 'info', 3000);
                }
            }

            // Sort: Native voices first, then Multilingual, then alphabetical
            filtered.sort((a, b) => {
                if (lang) {
                    const aIsNative = a.language_code === lang;
                    const bIsNative = b.language_code === lang;
                    if (aIsNative && !bIsNative) return -1;
                    if (!aIsNative && bIsNative) return 1;
                }
                return a.name.localeCompare(b.name);
            });

            sel.innerHTML = filtered.map(v => {
                const badge = v.is_multilingual ? '' : '';
                return `<option value="${v.id}">${v.name} (${v.language_code} ¬∑ ${v.gender})${badge}</option>`;
            }).join('');

            if (!filtered.length) {
                sel.innerHTML = '<option value="">No voices found</option>';
            }

            // Try restore previous selection
            if (prevVal && filtered.some(v => v.id === prevVal)) sel.value = prevVal;
            else {
                // Default logic
                if (lang === 'id-ID') {
                    const idVoice = filtered.find(v => v.id === 'id-ID-GadisNeural') || filtered[0];
                    if (idVoice) sel.value = idVoice.id;
                } else if (!prevVal && filtered.length > 0) {
                    sel.value = filtered[0].id;
                }
            }

            updateFavoriteButton();
            updateStyleControls();
        }

        // ‚îÄ‚îÄ Char Counter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function updateCharCount() {
            const text = document.getElementById('tts-text').value;
            const limit = parseInt(document.getElementById('char-limit').textContent);
            const count = text.length;
            document.getElementById('char-count').textContent = count;

            const pct = Math.min(100, (count / limit) * 100);
            const bar = document.getElementById('char-bar');
            bar.style.width = pct + '%';
            bar.className = `h-full rounded-full transition-all ${pct > 90 ? 'bg-red-500' : pct > 70 ? 'bg-amber-500' : 'bg-brand-500'}`;
        }

        // ‚îÄ‚îÄ Slider Controls ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function updateSlider(id) {
            const val = parseFloat(document.getElementById(id).value);
            let displayVal;
            
            if (id === 'style-degree') {
                displayVal = val.toFixed(1);
            } else {
                const intVal = parseInt(val);
                const sign = intVal >= 0 ? '+' : '';
                const suffix = id === 'pitch' ? 'Hz' : '%';
                displayVal = `${sign}${intVal}${suffix}`;
            }
            
            document.getElementById(`${id}-value`).textContent = displayVal;
        }

        // ‚îÄ‚îÄ TTS Generation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function generateTTS() {
            const text = document.getElementById('tts-text').value.trim();
            const voice = document.getElementById('voice-select').value;
            const generateSubtitle = document.getElementById('generate-subtitle').checked;

            if (!text) { showToast('Please enter some text.', 'warning'); return; }
            if (!voice) { showToast('Please select a voice.', 'warning'); return; }

            const rateVal = parseInt(document.getElementById('rate').value);
            const pitchVal = parseInt(document.getElementById('pitch').value);
            const volumeVal = parseInt(document.getElementById('volume').value);
            
            // Get style parameters
            const style = document.getElementById('style-select').value || null;
            const styleDegree = style ? parseFloat(document.getElementById('style-degree').value) : null;

            const formatVal = (v, suffix) => v >= 0 ? `+${v}${suffix}` : `${v}${suffix}`;

            const btn = document.getElementById('generate-btn');
            const btnText = document.getElementById('btn-text');
            btn.disabled = true;
            btnText.textContent = 'Generating‚Ä¶';

            const headers = { 'Content-Type': 'application/json' };
            const token = AuthStore.getToken();
            if (token) headers['Authorization'] = `Bearer ${token}`;
            const apiKey = AuthStore.getApiKey();
            if (apiKey) headers['X-API-Key'] = apiKey;

            try {
                // If subtitle requested, call subtitle endpoint first
                if (generateSubtitle) {
                    const srtResp = await fetch('/api/v1/tts/subtitle', {
                        method: 'POST',
                        headers,
                        body: JSON.stringify({
                            text,
                            voice,
                            rate: formatVal(rateVal, '%'),
                            pitch: formatVal(pitchVal, 'Hz'),
                            volume: formatVal(volumeVal, '%'),
                            words_per_cue: 10,
                            style: style,
                            style_degree: styleDegree,
                        }),
                    });

                    if (!srtResp.ok) {
                        const err = await srtResp.json();
                        showToast(err.message || 'Subtitle generation failed.', 'error');
                        return;
                    }

                    const srtData = await srtResp.json();
                    currentSrtContent = srtData.srt;

                    // Update rate limit display from subtitle response
                    const remaining = srtResp.headers.get('X-RateLimit-Remaining-Day');
                    const limit = srtResp.headers.get('X-RateLimit-Limit-Day');
                    if (AuthStore.isAuthenticated() && remaining !== null) {
                        const used = parseInt(limit) - parseInt(remaining);
                        document.getElementById('usage-req').textContent = used;
                        const pct = (used / parseInt(limit)) * 100;
                        document.getElementById('usage-req-bar').style.width = pct + '%';
                    }
                }

                // Now generate audio (normal endpoint)
                const resp = await fetch('/api/v1/tts', {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({
                        text,
                        voice,
                        rate: formatVal(rateVal, '%'),
                        pitch: formatVal(pitchVal, 'Hz'),
                        volume: formatVal(volumeVal, '%'),
                        style: style,
                        style_degree: styleDegree,
                    }),
                });

                if (!resp.ok) {
                    const err = await resp.json();
                    showToast(err.message || 'TTS generation failed.', 'error');
                    // Show rate limit info
                    if (resp.status === 429) {
                        const ra = resp.headers.get('Retry-After');
                        if (ra) showToast(`Retry after ${Math.ceil(ra / 60)} min.`, 'info', 8000);
                    }
                    return;
                }

                // Update rate limit display
                const remaining = resp.headers.get('X-RateLimit-Remaining-Day');
                const limit = resp.headers.get('X-RateLimit-Limit-Day');
                const cached = resp.headers.get('X-Cache-Hit') === 'true';

                if (AuthStore.isAuthenticated() && remaining !== null) {
                    const used = parseInt(limit) - parseInt(remaining);
                    document.getElementById('usage-req').textContent = used;
                    const pct = (used / parseInt(limit)) * 100;
                    document.getElementById('usage-req-bar').style.width = pct + '%';
                }

                // Play audio
                const blob = await resp.blob();
                currentAudioBlob = blob;
                const url = URL.createObjectURL(blob);
                const player = document.getElementById('audio-player');
                player.src = url;

                // Show audio section
                document.getElementById('audio-section').classList.remove('hidden');
                document.getElementById('audio-voice-label').textContent = voice.split('-').slice(2).join(' ');
                document.getElementById('cache-badge').classList.toggle('hidden', !cached);

                // Download link
                const dlBtn = document.getElementById('download-btn');
                dlBtn.href = url;
                dlBtn.download = `tts_${voice}_${Date.now()}.mp3`;

                // SRT download button
                const srtBtn = document.getElementById('download-srt-btn');
                if (currentSrtContent) {
                    const srtBlob = new Blob([currentSrtContent], { type: 'text/plain' });
                    const srtUrl = URL.createObjectURL(srtBlob);
                    srtBtn.href = srtUrl;
                    srtBtn.download = `tts_${voice}_${Date.now()}.srt`;
                    srtBtn.classList.remove('hidden');
                } else {
                    srtBtn.classList.add('hidden');
                }

                // Initialize waveform visualizer
                if (!waveformVisualizer) {
                    waveformVisualizer = new WaveformVisualizer('waveform-canvas', player);
                }
                await waveformVisualizer.loadAudio(url);

                player.play().catch(() => { });
                showToast(cached ? '‚ö° Served from cache' : 'Speech generated!', 'success', 3000);

            } catch (e) {
                showToast('Network error. Please try again.', 'error');
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Generate Speech';
            }
        }

        // ‚îÄ‚îÄ Turnstile Management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let turnstileWidgets = { login: null, register: null };
        let turnstileConfig = { enabled: false, sitekey: null };

        async function loadTurnstileConfig() {
            try {
                const resp = await fetch('/api/v1/auth/turnstile-config');
                turnstileConfig = await resp.json();
                
                // Hide Turnstile containers if not enabled
                if (!turnstileConfig.enabled) {
                    const loginContainer = document.getElementById('cf-turnstile-login');
                    const registerContainer = document.getElementById('cf-turnstile-register');
                    if (loginContainer) loginContainer.style.display = 'none';
                    if (registerContainer) registerContainer.style.display = 'none';
                }
            } catch (e) {
                console.error('Failed to load Turnstile config:', e);
            }
        }

        function initTurnstile() {
            if (!window.turnstile || !turnstileConfig.enabled || !turnstileConfig.sitekey) return;
            
            // Render login widget
            const loginContainer = document.getElementById('cf-turnstile-login');
            if (loginContainer && !turnstileWidgets.login) {
                turnstileWidgets.login = turnstile.render('#cf-turnstile-login', {
                    sitekey: turnstileConfig.sitekey,
                    theme: 'dark',
                });
            }
            
            // Render register widget
            const registerContainer = document.getElementById('cf-turnstile-register');
            if (registerContainer && !turnstileWidgets.register) {
                turnstileWidgets.register = turnstile.render('#cf-turnstile-register', {
                    sitekey: turnstileConfig.sitekey,
                    theme: 'dark',
                });
            }
        }

        // ‚îÄ‚îÄ Modal Management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function openModal(type = 'login') {
            document.getElementById('modal-overlay').classList.remove('hidden');
            document.getElementById('modal-overlay').classList.add('flex');
            switchModal(type);
            
            // Initialize Turnstile when modal opens
            setTimeout(() => initTurnstile(), 100);
        }
        function closeModal() {
            document.getElementById('modal-overlay').classList.add('hidden');
            document.getElementById('modal-overlay').classList.remove('flex');
        }
        function switchModal(type) {
            ['login', 'register', 'forgot'].forEach(t => {
                document.getElementById(`form-${t}`).classList.add('hidden');
            });
            document.getElementById(`form-${type}`).classList.remove('hidden');
            document.getElementById('modal-title').textContent = type === 'login' ? 'Sign In' : type === 'register' ? 'Create Account' : 'Reset Password';
            document.getElementById('modal-subtitle').textContent = type === 'login' ? 'Welcome back' : type === 'register' ? 'Free forever. 30 req/day.' : 'Enter your email';

            // Reset Turnstile on switch
            if (window.turnstile) {
                if (turnstileWidgets.login) turnstile.reset(turnstileWidgets.login);
                if (turnstileWidgets.register) turnstile.reset(turnstileWidgets.register);
            }
        }

        // ‚îÄ‚îÄ Auth Actions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function doLogin() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            if (!email || !password) { showToast('Fill all fields.', 'warning'); return; }

            let turnstileToken = null;
            if (turnstileConfig.enabled && window.turnstile && turnstileWidgets.login) {
                turnstileToken = turnstile.getResponse(turnstileWidgets.login);
                if (!turnstileToken) {
                    showToast('Please complete the verification challenge.', 'warning');
                    return;
                }
            }

            try {
                await ApiClient.auth.login(email, password, turnstileToken);
                closeModal();
                showToast('Logged in!', 'success');
                await updateUIForAuth();
            } catch (e) {
                showToast(e.message || 'Login failed.', 'error');
                if (window.turnstile && turnstileWidgets.login) {
                    turnstile.reset(turnstileWidgets.login);
                }
            }
        }

        async function doRegister() {
            const email = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-password').value;
            const name = document.getElementById('reg-name').value.trim();
            const tos = document.getElementById('reg-tos').checked;
            if (!email || !password) { showToast('Fill all fields.', 'warning'); return; }
            if (!tos) { showToast('Please accept the Terms of Service.', 'warning'); return; }

            let turnstileToken = null;
            if (turnstileConfig.enabled && window.turnstile && turnstileWidgets.register) {
                turnstileToken = turnstile.getResponse(turnstileWidgets.register);
                if (!turnstileToken) {
                    showToast('Please complete the verification challenge.', 'warning');
                    return;
                }
            }

            try {
                await ApiClient.auth.register(email, password, name, tos, turnstileToken);
                switchModal('login');
                showToast('Account created! Check your email for verification.', 'success', 7000);
            } catch (e) {
                showToast(e.message || 'Registration failed.', 'error');
                if (window.turnstile && turnstileWidgets.register) {
                    turnstile.reset(turnstileWidgets.register);
                }
            }
        }

        async function doForgot() {
            const email = document.getElementById('forgot-email').value.trim();
            if (!email) { showToast('Enter your email.', 'warning'); return; }
            try {
                await ApiClient.auth.forgotPassword(email);
                closeModal();
                showToast('Reset link sent if email is registered.', 'success', 6000);
            } catch (e) {
                showToast(e.message || 'Failed to send reset link.', 'error');
            }
        }

        async function updateUIForAuth() {
            const isAuth = AuthStore.isAuthenticated();
            document.getElementById('nav-auth-anon').classList.toggle('hidden', isAuth);
            document.getElementById('nav-auth-user').classList.toggle('hidden', !isAuth);
            document.getElementById('nav-auth-user').classList.toggle('flex', isAuth);

            if (isAuth) {
                const user = AuthStore.getUser();
                if (user?.email) document.getElementById('nav-user-email').textContent = user.email;

                document.getElementById('usage-anon').classList.add('hidden');
                document.getElementById('usage-user').classList.remove('hidden');
                document.getElementById('api-key-widget').classList.remove('hidden');

                // Set char limit for registered
                const textarea = document.getElementById('tts-text');
                textarea.maxLength = 2000;
                document.getElementById('char-limit').textContent = '2000';
                updateCharCount();

                // API key display
                const apiKey = AuthStore.getApiKey();
                if (apiKey) {
                    document.getElementById('api-key-display').textContent = apiKey;
                }

                // Load usage  
                try {
                    const data = await ApiClient.auth.me();
                    if (data.user?.usage) {
                        const u = data.user.usage;
                        document.getElementById('usage-req').textContent = u.requests;
                        document.getElementById('usage-req-limit').textContent = u.requests_limit;
                        document.getElementById('usage-chars').textContent = u.chars;
                        document.getElementById('usage-chars-limit').textContent = u.chars_limit;
                        document.getElementById('usage-req-bar').style.width = `${(u.requests / u.requests_limit) * 100}%`;
                        document.getElementById('usage-chars-bar').style.width = `${(u.chars / u.chars_limit) * 100}%`;
                    }
                    if (data.user?.api_key) {
                        document.getElementById('api-key-display').textContent = data.user.api_key;
                    }
                } catch (e) { }
            } else {
                // Info banner for anonymous
                const banner = document.getElementById('info-banner');
                banner.classList.remove('hidden');
                document.getElementById('info-banner-text').innerHTML =
                    'You\'re using eidosSpeech as guest (5 req/day, 500ch). <button onclick="openModal(\'register\')" class="underline font-medium">Register free</button> for 30 req/day and API access.';
            }
        }

        async function copyApiKey() {
            const key = document.getElementById('api-key-display').textContent;
            if (!key || key === '‚Äî') return;
            await navigator.clipboard.writeText(key).catch(() => { });
            showToast('API key copied!', 'success', 2000);
        }

        // ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        document.addEventListener('DOMContentLoaded', async () => {
            await loadTurnstileConfig();
            await AuthStore.init();
            await updateUIForAuth();
            await loadVoices();
            await loadPresets();
            await loadVoiceStyles();

            // Voice select change listener
            document.getElementById('voice-select').addEventListener('change', () => {
                updateFavoriteButton();
                updateStyleControls();
            });

            // Keyboard shortcuts integration
            document.addEventListener('shortcut', (e) => {
                const action = e.detail.action;
                if (action === 'generate') generateTTS();
                else if (action === 'play') {
                    const player = document.getElementById('audio-player');
                    if (player.paused) player.play();
                    else player.pause();
                }
                else if (action === 'download') {
                    const dlBtn = document.getElementById('download-btn');
                    if (dlBtn.href !== '#') dlBtn.click();
                }
                else if (action === 'downloadSrt') {
                    const srtBtn = document.getElementById('download-srt-btn');
                    if (!srtBtn.classList.contains('hidden') && srtBtn.href !== '#') {
                        srtBtn.click();
                    }
                }
                else if (action === 'stop') {
                    const player = document.getElementById('audio-player');
                    player.pause();
                    player.currentTime = 0;
                }
            });

            // Logout button
            document.getElementById('nav-logout-btn').addEventListener('click', async () => {
                await ApiClient.auth.logout();
                showToast('Logged out.', 'info');
                window.location.reload();
            });

            // Hash-based modal trigger
            if (window.location.hash === '#register') openModal('register');
            if (window.location.hash === '#login') openModal('login');
        });
    </script>
</body>

</html>
